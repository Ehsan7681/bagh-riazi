<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø§Øº Ø±ÛŒØ§Ø¶ÛŒ - Ù†Ø³Ø®Ù‡ Ø§Ø³ØªÛŒÚ©Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #FFFbeb;
            touch-action: manipulation;
            overflow: hidden;
            user-select: none;
        }

        /* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ --- */
        @keyframes pulse-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-pop { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-pulse-slow { animation: pulse-scale 2s infinite ease-in-out; }
        .animate-float { animation: float 3s infinite ease-in-out; }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ --- */
        .btn-game {
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15);
        }
        .btn-game:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ø±ÛŒØ§Ø¶ÛŒ --- */
        .crossed-out {
            opacity: 0.5;
            position: relative;
            filter: grayscale(100%);
        }
        .crossed-out::after {
            content: 'âŒ';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120%;
            color: red;
            text-shadow: 2px 2px 0px white;
        }
        .union-container {
            border: 3px dashed #A78BFA;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            position: relative;
        }
        .union-label {
            position: absolute;
            bottom: -15px; left: 50%;
            transform: translateX(-50%);
            background: #A78BFA;
            color: white;
            padding: 2px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .item-icon {
            font-size: 2.8rem;
            display: flex; align-items: center; justify-content: center;
            width: 3.5rem; height: 3.5rem;
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .feedback-card {
            background: white; width: 85%; max-width: 320px;
            border-radius: 30px; padding: 20px; text-align: center;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 6px solid white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay.active .feedback-card { transform: scale(1); }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø³ØªÛŒÚ©Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡ --- */
        .sticker-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        .sticker-card:active { transform: scale(0.95); }

        /* Ø­Ø§Ù„Øª Ù‚ÙÙ„ */
        .sticker-locked {
            background: #e2e8f0; /* gray-200 */
            filter: grayscale(100%);
            opacity: 0.8;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .sticker-locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem; opacity: 0.5;
        }

        /* Ø§ÙÚ©Øª Ø¯Ø±Ø®Ø´Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ÛŒ Ú©Ù…ÛŒØ§Ø¨ */
        @keyframes shine {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(150%) skewX(-15deg); }
        }
        .rare-shine::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-150%) skewX(-15deg);
            animation: shine 3s infinite;
        }

        /* Ø§ÙÚ©Øª Ø¨Ø§Ø² Ø´Ø¯Ù† Ø§Ø³ØªÛŒÚ©Ø± Ø¬Ø¯ÛŒØ¯ */
        .sticker-unlock-modal {
            position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .sticker-unlock-modal.active { opacity: 1; pointer-events: auto; }
        
        .rays {
            position: absolute; width: 600px; height: 600px;
            background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.1) 0deg 20deg, transparent 20deg 40deg);
            animation: spin 10s linear infinite;
            z-index: -1;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØ§ÛŒÙ…Ø± */
        @keyframes time-low-pulse {
           0%, 100% { transform: scale(1) rotate(2deg); }
           50% { transform: scale(1.1) rotate(2deg); }
        }
        .time-low {
           animation: time-low-pulse 1s infinite;
           background-color: #ef4444 !important;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col">

    <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø³ØªÛŒÚ©Ø± Ø¬Ø¯ÛŒØ¯ -->
    <div id="new-sticker-modal" class="sticker-unlock-modal">
        <div class="rays"></div>
        <div class="text-white text-3xl font-black mb-4 drop-shadow-md animate-bounce">Ø¬Ø§ÛŒØ²Ù‡ Ø¬Ø¯ÛŒØ¯! ğŸ‰</div>
        <div id="new-sticker-icon" class="text-9xl animate-pop mb-6 filter drop-shadow-2xl">ğŸ</div>
        <div class="bg-white p-6 rounded-3xl text-center max-w-xs shadow-2xl transform rotate-1 border-4 border-yellow-300">
            <h3 id="new-sticker-name" class="text-2xl font-black text-purple-600 mb-2">Ù†Ø§Ù… Ø§Ø³ØªÛŒÚ©Ø±</h3>
            <p id="new-sticker-desc" class="text-gray-500 font-bold">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø³ØªÛŒÚ©Ø±</p>
        </div>
        <button onclick="closeStickerModal()" class="mt-8 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-3 rounded-full text-xl font-black shadow-lg hover:scale-105 transition border-b-4 border-orange-600">
            Ø§ÛŒÙˆÙ„! ğŸ˜
        </button>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙÛŒØ¯Ø¨Ú© Ø¨Ø§Ø²ÛŒ -->
    <div id="feedback-modal" class="modal-overlay">
        <div class="feedback-card" id="feedback-card-inner">
            <!-- Ù…Ø­ØªÙˆØ§ Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        </div>
    </div>

    <!-- Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ -->
    <div id="home-screen" class="absolute inset-0 bg-gradient-to-b from-sky-200 to-indigo-100 flex flex-col items-center justify-center p-6 z-20">
        <button onclick="showStickerCollection()" class="absolute top-5 right-5 bg-white/80 p-3 rounded-2xl shadow-md text-3xl hover:bg-white transition hover:scale-110 border-b-4 border-gray-200">ğŸ…</button>
        
        <div class="text-center mb-6 animate-float">
            <h1 class="text-5xl font-black text-pink-500 drop-shadow-lg mb-4" style="-webkit-text-stroke: 2px white;">Ø¨Ø§Øº Ø±ÛŒØ§Ø¶ÛŒ</h1>
            <div class="bg-white/50 px-6 py-2 rounded-full backdrop-blur-sm">
                <p class="text-xl text-indigo-600 font-bold">Ø¨Ø§Ø²ÛŒ Ú©Ù† Ùˆ Ø¬Ø§ÛŒØ²Ù‡ Ø¨Ú¯ÛŒØ±! ğŸ“</p>
            </div>
            <!-- Ù†Ù…Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ -->
            <div class="flex gap-2 mt-4 justify-center">
                <div class="bg-yellow-300/80 px-3 py-1 rounded-full backdrop-blur-sm shadow border-2 border-yellow-400">
                    <p class="text-sm text-yellow-900 font-bold">ğŸ† Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„: <span id="home-score-basic">0</span></p>
                </div>
                <div class="bg-red-300/80 px-3 py-1 rounded-full backdrop-blur-sm shadow border-2 border-red-400">
                    <p class="text-sm text-red-900 font-bold">ğŸš€ Ù¾ÛŒØ´Ø±ÙØªÙ‡: <span id="home-score-advanced">0</span></p>
                </div>
            </div>
        </div>

        <div class="w-full max-w-sm space-y-4">
            <!-- Ø¨Ø§Ø²ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ -->
            <button onclick="startAdventureMode()" class="btn-game w-full bg-teal-500 hover:bg-teal-600 border-b-4 border-teal-700 text-white text-3xl font-bold py-5 rounded-3xl flex items-center justify-center gap-3 animate-pulse-slow">
                <span>â­</span> Ø¨Ø§Ø²ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ
            </button>

            <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white/40 p-2 rounded-2xl">
                    <h2 class="text-sm font-black text-center text-indigo-600 mb-2">Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„</h2>
                    <div class="space-y-2">
                        <button onclick="startGame('add')" class="btn-game w-full bg-green-400 border-b-4 border-green-600 text-white text-lg font-bold py-2 rounded-xl">Ø¬Ù…Ø¹ (+)</button>
                        <button onclick="startGame('subtract')" class="btn-game w-full bg-orange-400 border-b-4 border-orange-600 text-white text-lg font-bold py-2 rounded-xl">ØªÙØ±ÛŒÙ‚ (-)</button>
                        <button onclick="startGame('compare')" class="btn-game w-full bg-blue-400 border-b-4 border-blue-600 text-white text-lg font-bold py-2 rounded-xl">Ù…Ù‚Ø§ÛŒØ³Ù‡ (<>)</button>
                        <button onclick="startChallenge('basic')" class="btn-game w-full bg-rose-400 border-b-4 border-rose-600 text-white text-lg font-bold py-2 rounded-xl">Ú†Ø§Ù„Ø´ÛŒ â±ï¸</button>
                    </div>
                </div>
                <div class="bg-white/40 p-2 rounded-2xl">
                    <h2 class="text-sm font-black text-center text-indigo-600 mb-2">Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
                    <div class="space-y-2">
                        <button onclick="startGame('multiply')" class="btn-game w-full bg-purple-400 border-b-4 border-purple-600 text-white text-lg font-bold py-2 rounded-xl">Ø¶Ø±Ø¨ (Ã—)</button>
                        <button onclick="startGame('divide')" class="btn-game w-full bg-sky-400 border-b-4 border-sky-600 text-white text-lg font-bold py-2 rounded-xl">ØªÙ‚Ø³ÛŒÙ… (Ã·)</button>
                        <div class="h-10"></div> <!-- ÙØ§ØµÙ„Ù‡ Ù¾Ø±Ú©Ù† -->
                        <button onclick="startChallenge('advanced')" class="btn-game w-full bg-red-500 border-b-4 border-red-700 text-white text-lg font-bold py-2 rounded-xl">Ú†Ø§Ù„Ø´ÛŒ â±ï¸</button>
                    </div>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4 font-bold">Ù†Ø³Ø®Ù‡ Û³.Û° - Ø³ÛŒØ³ØªÙ… Ø¬ÙˆØ§ÛŒØ² Ø¬Ø¯ÛŒØ¯</p>
    </div>

    <!-- ØµÙØ­Ù‡ Ú©Ù„Ú©Ø³ÛŒÙˆÙ† Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ (Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡) -->
    <div id="sticker-collection-screen" class="hidden absolute inset-0 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 flex flex-col items-center p-4 z-30 overflow-hidden">
        <!-- Ù‡Ø¯Ø± -->
        <div class="w-full max-w-md flex justify-between items-center mb-4 mt-2 bg-white/60 p-3 rounded-2xl backdrop-blur-sm shadow-sm">
            <h1 class="text-2xl font-black text-purple-700">Ø¯ÙØªØ±Ú†Ù‡ Ø¬ÙˆØ§ÛŒØ² ğŸ“’</h1>
            <div class="bg-purple-100 px-4 py-1 rounded-full shadow-inner border border-purple-200">
                <span class="font-bold text-purple-800 text-sm"><span id="stickers-count">0</span> Ø§Ø² <span id="stickers-total">0</span></span>
            </div>
        </div>
    
        <!-- Ù„ÛŒØ³Øª Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ -->
        <div id="sticker-grid" class="w-full max-w-md grid grid-cols-3 gap-3 flex-1 overflow-y-auto pb-24 px-1 scroll-smooth content-start">
            <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªÛŒÚ©Ø± Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
    
        <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª -->
        <div class="absolute bottom-6 w-full flex justify-center pointer-events-none">
            <button onclick="hideStickerCollection()" class="pointer-events-auto bg-white px-10 py-3 rounded-2xl shadow-xl text-xl font-black text-purple-600 hover:bg-gray-50 border-b-4 border-gray-200 transition active:translate-y-1 active:border-b-0">
                Ø¨Ø§Ø²Ú¯Ø´Øª ğŸ 
            </button>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ -->
    <div id="game-screen" class="hidden w-full h-full flex flex-col bg-gradient-to-b from-blue-50 to-purple-50">
        
        <div class="flex justify-between items-center p-4">
            <button onclick="showHome()" class="bg-white p-3 rounded-2xl shadow-sm text-2xl hover:bg-gray-50 border-b-2 border-gray-200">ğŸ </button>
           
            <div id="adventure-level-display" class="hidden bg-teal-500 px-4 py-2 rounded-full shadow-lg border-2 border-white">
                <span class="text-xl font-black text-white">Ù…Ø±Ø­Ù„Ù‡: <span id="current-level">1</span></span>
            </div>

            <div id="timer-display" class="hidden bg-red-500 px-4 py-2 rounded-full shadow-lg border-2 border-white transform rotate-2">
               <span class="text-xl font-black text-white">â±ï¸ <span id="time-left">60</span></span>
           </div>

            <div id="score-display" class="bg-yellow-400 px-4 py-2 rounded-full shadow-lg border-2 border-white transform -rotate-2">
                <span class="text-xl font-black text-yellow-900">Ø§Ù…ØªÛŒØ§Ø²: <span id="score">0</span></span>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center px-4 pt-2 pb-8 gap-4 overflow-y-auto">
            
            <!-- Ø¨Ø®Ø´ ØªØµÙˆÛŒØ±ÛŒ -->
            <div class="w-full bg-white rounded-3xl shadow-xl p-4 border-4 border-blue-100 min-h-[260px] flex flex-col items-center justify-center relative overflow-hidden">
                <div class="absolute top-[-50%] right-[-50%] w-full h-full bg-blue-50 rounded-full opacity-50 z-0 pointer-events-none"></div>
                
                <div id="visual-container" class="w-full z-10 flex justify-center items-center min-h-[160px]">
                    <!-- Ù…Ø­ØªÙˆØ§ -->
                </div>

                <div class="mt-4 bg-gray-100 px-6 py-2 rounded-2xl flex items-center gap-2 text-4xl font-black text-gray-600 z-10 shadow-inner" dir="ltr">
                    <span id="math-n1" class="text-blue-500"></span>
                    <span id="math-op" class="text-gray-400"></span>
                    <span id="math-n2" class="text-pink-500"></span>
                    <span class="text-gray-300">=</span>
                    <span class="text-purple-600">?</span>
                </div>
            </div>

            <div id="hint-text" class="text-base font-bold text-indigo-400 h-6 text-center">
                <!-- Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ -->
            </div>

            <div id="options-container" class="w-full grid grid-cols-3 gap-3 mt-auto">
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
            </div>
        </div>
    </div>

    <script>
        // --- Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ (Achievement System) ---
        const STICKER_DB = [
            // Ø³Ø·Ø­ Û±: Ø´Ø±ÙˆØ¹ Ú©Ù†Ù†Ø¯Ù‡
            { id: 's_welcome', icon: 'ğŸ£', name: 'ØªØ§Ø²Ù‡ ÙˆØ§Ø±Ø¯', desc: 'Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡', rarity: 'common', check: (s) => s.totalGames >= 1 },
            { id: 's_score10', icon: 'ğŸ¥‰', name: 'Ø´Ø§Ú¯Ø±Ø¯ Ø®ÙˆØ¨', desc: 'Û±Û° ØªØ§ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª Ø¨Ø¯Ù‡', rarity: 'common', check: (s) => s.totalCorrect >= 10 },
            { id: 's_add_novice', icon: 'â•', name: 'Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ Û±', desc: 'Û³ Ø¨Ø§Ø± Ø¨Ø§Ø²ÛŒ Ø¬Ù…Ø¹ Ø±Ùˆ Ø¨Ø¨Ø±', rarity: 'common', check: (s) => s.winsAdd >= 3 },
            
            // Ø³Ø·Ø­ Û²: ØªÙ„Ø§Ø´Ú¯Ø±
            { id: 's_sub_novice', icon: 'â–', name: 'Ú©Ù…â€ŒÚ©Ù†Ù†Ø¯Ù‡ Û±', desc: 'Û³ Ø¨Ø§Ø± Ø¨Ø§Ø²ÛŒ ØªÙØ±ÛŒÙ‚ Ø±Ùˆ Ø¨Ø¨Ø±', rarity: 'common', check: (s) => s.winsSub >= 3 },
            { id: 's_compare_novice', icon: 'âš–ï¸', name: 'ØªØ±Ø§Ø²Ùˆ', desc: 'Û³ Ø¨Ø§Ø± Ø¨Ø§Ø²ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±Ùˆ Ø¨Ø¨Ø±', rarity: 'common', check: (s) => s.winsCompare >= 3 },
            { id: 's_level5', icon: 'ğŸƒâ€â™‚ï¸', name: 'Ù…Ø§Ø¬Ø±Ø§Ø¬Ùˆ', desc: 'Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ûµ Ù…Ø§Ø¬Ø±Ø§Ø¬ÙˆÛŒÛŒ Ø¨Ø±Ø³', rarity: 'rare', check: (s) => s.maxLevel >= 5 },
            
            // Ø³Ø·Ø­ Û³: Ù¾ÛŒØ´Ø±ÙØªÙ‡
            { id: 's_score50', icon: 'ğŸ¥ˆ', name: 'Ø±ÛŒØ§Ø¶ÛŒâ€ŒØ¯Ø§Ù†', desc: 'ÛµÛ° ØªØ§ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª Ø¬Ù…Ø¹ Ú©Ù†', rarity: 'rare', check: (s) => s.totalCorrect >= 50 },
            { id: 's_mul_master', icon: 'âœ–ï¸', name: 'Ø¶Ø±Ø¨â€ŒØ¯Ø±', desc: 'Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨ Ø±Ùˆ ÛŒØ§Ø¯ Ú¯Ø±ÙØªÛŒ! (Ûµ Ø¨Ø±Ø¯)', rarity: 'rare', check: (s) => s.winsMul >= 5 },
            { id: 's_div_master', icon: 'â—', name: 'ØªÙ‚Ø³ÛŒÙ…â€ŒÚ¯Ø±', desc: 'Ûµ Ø¨Ø§Ø± Ø¨Ø§Ø²ÛŒ ØªÙ‚Ø³ÛŒÙ… Ø±Ùˆ Ø¨Ø¨Ø±', rarity: 'rare', check: (s) => s.winsDiv >= 5 },

            // Ø³Ø·Ø­ Û´: Ù‚Ù‡Ø±Ù…Ø§Ù†
            { id: 's_challenge_basic', icon: 'ğŸï¸', name: 'Ø³Ø±Ø¹ØªÛŒ', desc: 'Ø§Ù…ØªÛŒØ§Ø² Û²Û° Ø¯Ø± Ú†Ø§Ù„Ø´ÛŒ Ø³Ø§Ø¯Ù‡', rarity: 'epic', check: (s) => s.highScoreBasic >= 20 },
            { id: 's_level15', icon: 'ğŸ°', name: 'Ø´ÙˆØ§Ù„ÛŒÙ‡ Ø¨Ø§Øº', desc: 'Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û±Ûµ Ø¨Ø±Ø³', rarity: 'epic', check: (s) => s.maxLevel >= 15 },
            { id: 's_score100', icon: 'ğŸ¥‡', name: 'ØµØ¯ØªØ§ÛŒÛŒ', desc: 'Û±Û°Û° ØªØ§ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª!', rarity: 'epic', check: (s) => s.totalCorrect >= 100 },

            // Ø³Ø·Ø­ Ûµ: Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ
            { id: 's_expert', icon: 'ğŸ§ ', name: 'Ù†Ø§Ø¨ØºÙ‡', desc: 'Ø§Ù…ØªÛŒØ§Ø² Û³Û° Ø¯Ø± Ú†Ø§Ù„Ø´ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡', rarity: 'legendary', check: (s) => s.highScoreAdv >= 30 },
            { id: 's_master', icon: 'ğŸ†', name: 'Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¬Ù‡Ø§Ù†', desc: 'ÛµÛ°Û° ØªØ§ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª!', rarity: 'legendary', check: (s) => s.totalCorrect >= 500 },
            { id: 's_king', icon: 'ğŸ‘‘', name: 'Ù¾Ø§Ø¯Ø´Ø§Ù‡ Ø¨Ø§Øº', desc: 'Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ ÛµÛ° Ø¨Ø±Ø³', rarity: 'legendary', check: (s) => s.maxLevel >= 50 }
        ];

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† ---
        let playerStats = {
            totalGames: 0,
            totalCorrect: 0,
            maxLevel: 1,
            winsAdd: 0,
            winsSub: 0,
            winsMul: 0,
            winsDiv: 0,
            winsCompare: 0,
            highScoreBasic: 0,
            highScoreAdv: 0,
            unlockedStickers: [] // IDs only
        };

        // ØµÙ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
        let stickerNotificationQueue = [];

        function loadUserData() {
            const saved = localStorage.getItem('mathGardenStats_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                playerStats = { ...playerStats, ...parsed };
            }
            updateHomeStats();
        }

        function saveUserData() {
            localStorage.setItem('mathGardenStats_v3', JSON.stringify(playerStats));
            updateHomeStats();
        }

        function updateHomeStats() {
            document.getElementById('home-score-basic').innerText = playerStats.highScoreBasic.toLocaleString('fa-IR');
            document.getElementById('home-score-advanced').innerText = playerStats.highScoreAdv.toLocaleString('fa-IR');
        }

        function updateStats(type, isWin, currentScore = 0) {
            playerStats.totalGames++;
            if(isWin) {
                playerStats.totalCorrect++;
                if(type === 'add') playerStats.winsAdd++;
                if(type === 'subtract') playerStats.winsSub++;
                if(type === 'multiply') playerStats.winsMul++;
                if(type === 'divide') playerStats.winsDiv++;
                if(type === 'compare') playerStats.winsCompare++;
            }

            if (isAdventureMode) {
                if (currentLevel > playerStats.maxLevel) playerStats.maxLevel = currentLevel;
            }

            if (isChallengeMode) {
                if (challengeType === 'basic') {
                    if (currentScore > playerStats.highScoreBasic) playerStats.highScoreBasic = currentScore;
                } else {
                    if (currentScore > playerStats.highScoreAdv) playerStats.highScoreAdv = currentScore;
                }
            }

            saveUserData();
            checkNewStickers();
        }

        // --- Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø² Ø´Ø¯Ù† Ø§Ø³ØªÛŒÚ©Ø± ---
        function checkNewStickers() {
            let foundNew = false;

            STICKER_DB.forEach(sticker => {
                if (!playerStats.unlockedStickers.includes(sticker.id) && sticker.check(playerStats)) {
                    playerStats.unlockedStickers.push(sticker.id);
                    stickerNotificationQueue.push(sticker);
                    foundNew = true;
                }
            });

            if (foundNew) {
                saveUserData();
                
                // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ú†Ø§Ù„Ø´ÛŒ Ù‡Ø³ØªÛŒÙ…ØŒ Ù…Ø²Ø§Ø­Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ… Ùˆ ÙÙ‚Ø· Ø¯Ø± ØµÙ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
                if (!isChallengeMode) {
                    showNextSticker();
                }
            }
        }

        function showNextSticker() {
            // Ø§Ú¯Ø± Ù…ÙˆØ¯ÛŒ Ø¨Ø§Ø² Ø§Ø³ØªØŒ ØµØ¨Ø± Ú©Ù† (Ø§Ø² ØªØ¯Ø§Ø®Ù„ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
            if (document.getElementById('new-sticker-modal').classList.contains('active')) return;
            if (stickerNotificationQueue.length === 0) return;

            const sticker = stickerNotificationQueue.shift(); // Ø¨Ø±Ø¯Ø§Ø´ØªÙ† Ø§ÙˆÙ„ÛŒÙ† Ø¢ÛŒØªÙ…
            showNewStickerModal(sticker);
        }

        function showNewStickerModal(sticker) {
            const modal = document.getElementById('new-sticker-modal');
            document.getElementById('new-sticker-icon').innerText = sticker.icon;
            document.getElementById('new-sticker-name').innerText = sticker.name;
            document.getElementById('new-sticker-desc').innerText = sticker.desc;
            
            modal.classList.add('active');
            playSound('correct');
            triggerConfetti();
        }

        function closeStickerModal() {
            document.getElementById('new-sticker-modal').classList.remove('active');
            
            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§Ø³ØªÛŒÚ©Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± ØµÙ Ù‡Ø³Øª ÛŒØ§ Ù†Ù‡
            if (stickerNotificationQueue.length > 0) {
                setTimeout(showNextSticker, 300); // ÙˆÙ‚ÙÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ
            } else if (isChallengeMode && timeLeft <= 0) {
                // Ø§Ú¯Ø± Ú†Ø§Ù„Ø´ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ Ùˆ Ù‡Ù…Ù‡ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ Ø±Ø§ Ø¯ÛŒØ¯ÛŒÙ…ØŒ Ø¨Ø±Ùˆ Ø®Ø§Ù†Ù‡
                showHome();
            }
        }

        // --- Ø±Ù†Ø¯Ø± Ú©Ù„Ú©Ø³ÛŒÙˆÙ† Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ ---
        function renderStickers() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            
            document.getElementById('stickers-count').innerText = playerStats.unlockedStickers.length.toLocaleString('fa-IR');
            document.getElementById('stickers-total').innerText = STICKER_DB.length.toLocaleString('fa-IR');

            STICKER_DB.forEach(sticker => {
                const isUnlocked = playerStats.unlockedStickers.includes(sticker.id);
                
                const card = document.createElement('div');
                let classes = "sticker-card rounded-2xl p-2 flex flex-col items-center justify-between min-h-[130px] border-4 cursor-pointer relative ";
                
                if (!isUnlocked) {
                    classes += "sticker-locked border-gray-300";
                    card.innerHTML = `
                        <div class="flex-1 flex items-center justify-center opacity-30 text-4xl grayscale filter">${sticker.icon}</div>
                        <div class="w-full text-[10px] text-gray-500 font-bold text-center bg-white/60 rounded-lg px-1 py-1 mt-2">
                            ${sticker.desc}
                        </div>
                    `;
                } else {
                    if(sticker.rarity === 'common') classes += "bg-white border-blue-200 shadow-md";
                    if(sticker.rarity === 'rare') classes += "bg-gradient-to-b from-blue-50 to-purple-50 border-purple-300 shadow-lg rare-shine";
                    if(sticker.rarity === 'epic') classes += "bg-gradient-to-b from-rose-50 to-pink-100 border-rose-400 shadow-xl rare-shine";
                    if(sticker.rarity === 'legendary') classes += "bg-gradient-to-b from-yellow-50 to-amber-100 border-amber-400 shadow-2xl rare-shine";

                    card.innerHTML = `
                        <div class="text-5xl mb-1 filter drop-shadow-sm animate-pop mt-2">${sticker.icon}</div>
                        <div class="text-center w-full">
                            <div class="text-xs font-black text-gray-800 leading-tight mb-1">${sticker.name}</div>
                            <div class="text-[9px] text-gray-500 font-bold leading-tight px-1">${sticker.desc}</div>
                        </div>
                    `;
                    
                    card.onclick = () => {
                        card.style.transform = 'scale(0.9)';
                        setTimeout(() => card.style.transform = 'scale(1)', 150);
                    };
                }
                card.className = classes;
                grid.appendChild(card);
            });
        }

        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙˆØªÛŒ Ùˆ Ø¹Ù…ÙˆÙ…ÛŒ ---
        const audioContext = {
            correct: new Audio("https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"),
            wrong: new Audio("https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3")
        };

        function playSound(type) {
            try {
                const sound = audioContext[type];
                if(sound) {
                    sound.currentTime = 0; sound.volume = 0.5;
                    sound.play().catch(e => console.log("Audio blocked"));
                }
            } catch (e) { console.log("Audio Error", e); }
        }

        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ ---
        let score = 0;
        let currentMode = 'add';
        let correctAnswer = 0;
        let isLocked = false;
        let isChallengeMode = false;
        let isAdventureMode = false;
        let currentLevel = 1;
        let challengeType = 'basic';
        let timerInterval = null;
        let timeLeft = 60;
        let wrongAttempts = 0;

        const icons = ['ğŸ', 'ğŸ', 'ğŸ“', 'ğŸ„', 'ğŸ¼', 'ğŸ¦', 'ğŸš—', 'ğŸˆ', 'âš½', 'â­'];

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ---
        function startGame(mode) {
            setupGameEnvironment();
            isAdventureMode = false;
            isChallengeMode = false;
            currentMode = mode;
            score = 0;
            updateScoreDisplay();
            generateLevel();
        }

        function startChallenge(type) {
           setupGameEnvironment();
           isAdventureMode = false;
           isChallengeMode = true;
           challengeType = type;
           score = 0;
           updateScoreDisplay();
           
           document.getElementById('adventure-level-display').classList.add('hidden');
           document.getElementById('timer-display').classList.remove('hidden');
           startTimer();
           generateLevel();
        }

        function startAdventureMode() {
           setupGameEnvironment();
           isAdventureMode = true;
           isChallengeMode = false;
           currentLevel = playerStats.maxLevel;
           
           document.getElementById('score-display').classList.add('hidden');
           document.getElementById('adventure-level-display').classList.remove('hidden');
           document.getElementById('current-level').innerText = currentLevel.toLocaleString('fa-IR');
           document.getElementById('timer-display').classList.add('hidden');

           generateLevel();
        }

        function setupGameEnvironment() {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('sticker-collection-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            document.getElementById('adventure-level-display').classList.add('hidden');
            document.getElementById('score-display').classList.remove('hidden');
        }

        function showHome() {
           stopTimer();
           document.getElementById('game-screen').classList.add('hidden');
           document.getElementById('sticker-collection-screen').classList.add('hidden');
           document.getElementById('home-screen').classList.remove('hidden');
           updateHomeStats();
        }

        function showStickerCollection() {
           document.getElementById('home-screen').classList.add('hidden');
           renderStickers();
           document.getElementById('sticker-collection-screen').classList.remove('hidden');
        }

        function hideStickerCollection() {
           document.getElementById('sticker-collection-screen').classList.add('hidden');
           document.getElementById('home-screen').classList.remove('hidden');
        }

        function updateScoreDisplay() {
            document.getElementById('score').innerText = score.toLocaleString('fa-IR');
        }

        function generateLevel() {
           if (isChallengeMode && timeLeft <= 0) return;

           // Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
           if (isChallengeMode) {
               // Ú©Ù„Ø§Ø³ Ø§ÙˆÙ„: Ø¬Ù…Ø¹ + ØªÙØ±ÛŒÙ‚ + Ù…Ù‚Ø§ÛŒØ³Ù‡
               // Ù¾ÛŒØ´Ø±ÙØªÙ‡: Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯
               const modes = challengeType === 'basic' 
                   ? ['add', 'subtract', 'compare'] 
                   : ['add', 'subtract', 'multiply', 'divide', 'compare'];
               
               currentMode = modes[Math.floor(Math.random() * modes.length)];
           } else if (isAdventureMode) {
               const difficulty = Math.min(Math.floor(currentLevel / 5), 4);
               const adventureModes = ['add', 'subtract', 'compare'];
               if (currentLevel > 10) adventureModes.push('multiply');
               if (currentLevel > 20) adventureModes.push('divide');
               currentMode = adventureModes[Math.floor(Math.random() * adventureModes.length)];
           }

            isLocked = false;
            wrongAttempts = 0;
            closeFeedback();
            
            const visualContainer = document.getElementById('visual-container');
            const optionsContainer = document.getElementById('options-container');
            const hintText = document.getElementById('hint-text');
            
            visualContainer.innerHTML = '';
            optionsContainer.innerHTML = '';

            let n1, n2;
            const icon = icons[Math.floor(Math.random() * icons.length)];

            if (currentMode === 'add') {
                n1 = Math.floor(Math.random() * 6) + 1; 
                n2 = Math.floor(Math.random() * 6) + 1;
                correctAnswer = n1 + n2;
                document.getElementById('math-op').innerText = '+';
                hintText.innerText = "Ù‡Ù…Ù‡ Ø±Ùˆ Ø¨Ø§ Ù‡Ù… Ø¨Ø´Ù…Ø§Ø±!";
                const container = createUnionContainer(n1, n2, icon);
                visualContainer.appendChild(container);

            } else if (currentMode === 'subtract') {
                n1 = Math.floor(Math.random() * 8) + 2;
                n2 = Math.floor(Math.random() * (n1 - 1)) + 1;
                correctAnswer = n1 - n2;
                document.getElementById('math-op').innerText = '-';
                hintText.innerText = "Ú†Ù†Ø¯ ØªØ§ Ø´Ú©Ù„ Ø³Ø§Ù„Ù… Ù…ÙˆÙ†Ø¯Ù‡ØŸ";
                const container = document.createElement('div');
                container.className = "flex flex-wrap justify-center gap-2 p-2";
                for(let i=0; i<n1; i++) {
                    const span = createIcon(icon, i * 0.1);
                    if (i >= (n1 - n2)) {
                        span.classList.add('crossed-out');
                        setTimeout(() => { span.style.opacity = "0.5"; span.style.transform = "scale(0.9)"; }, 800 + (i * 100));
                    }
                    container.appendChild(span);
                }
                visualContainer.appendChild(container);

           } else if (currentMode === 'multiply') {
               n1 = Math.floor(Math.random() * 3) + 2;
               n2 = Math.floor(Math.random() * 4) + 2;
               correctAnswer = n1 * n2;
               document.getElementById('math-op').innerText = 'Ã—';
               hintText.innerText = `Ú†Ù†Ø¯ ØªØ§ Ø¯Ø³ØªÙ‡ ${n2.toLocaleString('fa-IR')} ØªØ§ÛŒÛŒØŸ`;
               const container = document.createElement('div');
               container.className = "flex flex-wrap justify-center items-center gap-2";
               for(let i=0; i<n1; i++) {
                   const group = document.createElement('div');
                   group.className = "flex flex-wrap justify-center gap-1 p-2 border-2 border-purple-200 rounded-xl bg-purple-50 animate-pop";
                   group.style.animationDelay = (i * 0.15) + 's';
                   for(let j=0; j<n2; j++) group.appendChild(createIcon(icon, 0));
                   container.appendChild(group);
               }
               visualContainer.appendChild(container);

           } else if (currentMode === 'divide') {
               const groupSize = Math.floor(Math.random() * 3) + 2;
               correctAnswer = Math.floor(Math.random() * 3) + 2;
               n1 = groupSize * correctAnswer;
               n2 = groupSize;
               document.getElementById('math-op').innerText = 'Ã·';
               hintText.innerText = `Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ ${n2.toLocaleString('fa-IR')} ØªØ§ÛŒÛŒ Ø¨Ø³Ø§Ø²!`;
               const container = document.createElement('div');
               container.id = "divide-container";
               container.className = "flex flex-wrap justify-center items-center gap-2";
               for(let i=0; i<n1; i++) {
                   const ic = createIcon(icon, i * 0.05);
                   ic.classList.add('division-icon');
                   container.appendChild(ic);
               }
               visualContainer.appendChild(container);

           } else if (currentMode === 'compare') {
               n1 = Math.floor(Math.random() * 9) + 1;
               do { n2 = Math.floor(Math.random() * 9) + 1; } while (n1 === n2 && Math.random() < 0.7);
               if (n1 > n2) correctAnswer = '>';
               else if (n1 < n2) correctAnswer = '<';
               else correctAnswer = '=';
               hintText.innerText = "Ú©Ø¯ÙˆÙ… Ø·Ø±Ù Ø¨ÛŒØ´ØªØ±Ù‡ØŸ";
               const container = document.createElement('div');
               container.className = "flex justify-around items-center w-full";
               const g1 = document.createElement('div');
               g1.className = "flex flex-wrap justify-center gap-1 p-2 border-2 border-blue-200 rounded-xl bg-blue-50 w-2/5";
               for(let i=0; i<n1; i++) g1.appendChild(createIcon(icon, i * 0.05));
               const q = document.createElement('div');
               q.className = "text-4xl font-black text-gray-300";
               q.innerText = "?";
               const g2 = document.createElement('div');
               g2.className = "flex flex-wrap justify-center gap-1 p-2 border-2 border-pink-200 rounded-xl bg-pink-50 w-2/5";
               for(let i=0; i<n2; i++) g2.appendChild(createIcon(icon, i * 0.05));
               container.appendChild(g1);
               container.appendChild(q);
               container.appendChild(g2);
               visualContainer.appendChild(container);
           }

           const mathPanel = document.querySelector('.mt-4.bg-gray-100');
           if (currentMode === 'compare') {
               mathPanel.classList.add('hidden');
           } else {
               mathPanel.classList.remove('hidden');
               document.getElementById('math-n1').innerText = n1.toLocaleString('fa-IR');
               document.getElementById('math-n2').innerText = n2.toLocaleString('fa-IR');
           }
           createOptions(correctAnswer);
        }

        function createIcon(char, delay) {
            const span = document.createElement('div');
            span.className = "item-icon animate-pop filter drop-shadow-sm cursor-pointer select-none";
            span.innerText = char;
            span.style.animationDelay = delay + "s";
            return span;
        }

        function createUnionContainer(n1, n2, icon) {
            const big = document.createElement('div');
            big.className = "union-container flex items-center justify-center gap-2 p-4 w-full animate-pop";
            const g1 = document.createElement('div');
            g1.className = "flex flex-wrap justify-center gap-1 max-w-[45%]";
            for(let i=0; i<n1; i++) g1.appendChild(createIcon(icon, i*0.1));
            const plus = document.createElement('div');
            plus.className = "text-4xl font-black text-green-500 mx-1";
            plus.innerText = "+";
            const g2 = document.createElement('div');
            g2.className = "flex flex-wrap justify-center gap-1 max-w-[45%]";
            for(let i=0; i<n2; i++) g2.appendChild(createIcon(icon, (n1*0.1)+(i*0.1)));
            big.appendChild(g1); big.appendChild(plus); big.appendChild(g2);
            const label = document.createElement('div');
            label.className = "union-label";
            label.innerText = "Ø¨Ø§ Ù‡Ù…...";
            big.appendChild(label);
            return big;
        }

        function createOptions(correct) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            let opts = [];

            if (currentMode === 'compare') {
                opts = ['<', '>', '='];
            } else {
                opts = [correct];
                while(opts.length < 3) {
                    let fake = correct + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 3) + 1);
                    if(fake >= 0 && !opts.includes(fake)) opts.push(fake);
                    else if (opts.length < 3 && !opts.includes(correct + 1)) opts.push(correct + 1);
                }
                opts.sort(() => Math.random() - 0.5);
            }

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "btn-game bg-white border-2 border-indigo-100 text-indigo-600 text-3xl font-black py-4 rounded-2xl hover:bg-indigo-50 active:bg-indigo-100";
                btn.innerText = typeof opt === 'number' ? opt.toLocaleString('fa-IR') : opt;
                btn.onclick = () => checkAnswer(opt, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selected, btn) {
            if(isLocked) return;

            if(selected === correctAnswer) {
                isLocked = true;
                if (currentMode === 'divide' && !isChallengeMode) {
                    animateDivisionGrouping(() => handleCorrectAnswer());
                } else {
                    handleCorrectAnswer();
                }
            } else {
                playSound('wrong');
                if (isChallengeMode) {
                    timeLeft = Math.max(0, timeLeft - 5);
                    document.getElementById('time-left').innerText = timeLeft;
                    btn.classList.add('bg-red-200', 'border-red-400');
                    setTimeout(() => btn.classList.remove('bg-red-200', 'border-red-400'), 500);
                } else {
                   wrongAttempts++;
                   btn.classList.add('shake', 'bg-red-100');
                   setTimeout(() => btn.classList.remove('shake', 'bg-red-100'), 500);
                   showFeedback(false, wrongAttempts >= 2);
                }
            }
        }

        function handleCorrectAnswer() {
           playSound('correct');
           if (isAdventureMode) {
               currentLevel++;
               document.getElementById('current-level').innerText = currentLevel.toLocaleString('fa-IR');
               updateStats(currentMode, true, 0);
               generateLevel();
               isLocked = false;
           } else {
               score++;
               updateScoreDisplay();
               updateStats(currentMode, true, score);

               if (isChallengeMode) {
                   generateLevel();
               } else {
                   triggerConfetti();
                   showFeedback(true);
               }
           }
        }

        function animateDivisionGrouping(callback) {
            const container = document.getElementById('divide-container');
            const icons = Array.from(container.getElementsByClassName('division-icon'));
            const n2 = icons.length / correctAnswer;
            container.innerHTML = ''; 
            container.style.gap = '0.75rem';

            for (let i = 0; i < correctAnswer; i++) {
                const group = document.createElement('div');
                group.className = "flex flex-wrap justify-center gap-1 p-2 border-4 border-dashed border-sky-300 rounded-2xl bg-sky-50";
                group.style.transform = 'scale(0)';
                group.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                container.appendChild(group);
                setTimeout(() => group.style.transform = 'scale(1)', i * 200);
                for (let j = 0; j < n2; j++) {
                    const idx = i * n2 + j;
                    if (icons[idx]) group.appendChild(icons[idx]);
                }
            }
            setTimeout(callback, correctAnswer * 200 + 600);
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ ---
        function showFeedback(isSuccess, showAnswer = false) {
            const modal = document.getElementById('feedback-modal');
            const card = document.getElementById('feedback-card-inner');
            modal.classList.add('active');
            
            if(isSuccess) {
                card.innerHTML = `
                    <div class="text-6xl mb-2 animate-bounce">ğŸ¤©</div>
                    <h2 class="text-2xl font-black text-green-500 mb-1">Ø¢ÙØ±ÛŒÙ†!</h2>
                    <button onclick="generateLevel()" class="w-full bg-green-500 text-white text-lg font-bold py-2 rounded-xl shadow-lg mt-4 hover:bg-green-600">Ø¨Ø¹Ø¯ÛŒ â¬…</button>
                `;
                card.style.borderColor = "#86efac";
            } else {
               if (showAnswer) {
                   card.innerHTML = `
                       <div class="text-6xl mb-2">ğŸ’¡</div>
                       <h2 class="text-2xl font-black text-sky-500 mb-1">Ø§Ø´Ú©Ø§Ù„ Ù†Ø¯Ø§Ø±Ù‡</h2>
                       <p class="text-gray-500 font-bold">Ø¬ÙˆØ§Ø¨: <span class="text-xl text-sky-600">${correctAnswer.toLocaleString('fa-IR')}</span></p>
                       <button onclick="generateLevel()" class="w-full bg-sky-500 text-white text-lg font-bold py-2 rounded-xl shadow-lg mt-4 hover:bg-sky-600">ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ…!</button>
                   `;
                   card.style.borderColor = "#38bdf8";
               } else {
                   card.innerHTML = `
                       <div class="text-6xl mb-2 animate-pulse">ğŸ¤”</div>
                       <h2 class="text-2xl font-black text-orange-500 mb-1">Ø¯Ù‚Øª Ú©Ù†!</h2>
                       <button onclick="retryLevel()" class="w-full bg-orange-400 text-white text-lg font-bold py-2 rounded-xl shadow-lg mt-4 hover:bg-orange-500">ØªÙ„Ø§Ø´ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
                   `;
                   card.style.borderColor = "#fdba74";
               }
           }
       }
       function closeFeedback() { document.getElementById('feedback-modal').classList.remove('active'); }
       function retryLevel() { isLocked = false; closeFeedback(); }

       // --- ØªØ§ÛŒÙ…Ø± Ùˆ Ù¾Ø§ÛŒØ§Ù† Ú†Ø§Ù„Ø´ÛŒ ---
       function startTimer() {
           timeLeft = 60;
           const timerEl = document.getElementById('timer-display');
           document.getElementById('time-left').innerText = timeLeft;
           timerEl.classList.remove('hidden', 'time-low');
           timerEl.style.backgroundColor = '#ef4444';
           stickerNotificationQueue = []; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ Ù‚Ø¨Ù„ÛŒ

           if(timerInterval) clearInterval(timerInterval);
           timerInterval = setInterval(() => {
               timeLeft--;
               document.getElementById('time-left').innerText = timeLeft;
               if (timeLeft <= 10) timerEl.classList.add('time-low');
               if (timeLeft <= 0) endChallenge();
           }, 1000);
       }
       function stopTimer() { clearInterval(timerInterval); }
       
       function endChallenge() {
           stopTimer(); isLocked = true;
           updateStats(currentMode, false, score); // Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø±Ú©ÙˆØ±Ø¯
           
           const modal = document.getElementById('feedback-modal');
           const card = document.getElementById('feedback-card-inner');
           modal.classList.add('active');
           card.style.borderColor = "#60a5fa";
           
           // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø­Ø§Ù„Ø§ Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ Ø±Ø§ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯
           card.innerHTML = `
               <div class="text-6xl mb-2">ğŸ</div>
               <h2 class="text-2xl font-black text-blue-500 mb-1">ÙˆÙ‚Øª ØªÙ…ÙˆÙ… Ø´Ø¯!</h2>
               <p class="text-gray-500 font-bold mb-4">Ø§Ù…ØªÛŒØ§Ø²: <span class="text-2xl text-blue-600">${score.toLocaleString('fa-IR')}</span></p>
               <button onclick="finishChallengeSequence()" class="w-full bg-blue-500 text-white text-lg font-bold py-2 rounded-xl shadow-lg hover:bg-blue-600">Ø§Ø¯Ø§Ù…Ù‡ â¬…</button>
           `;
       }
       
       // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒØ§Ù† Ú†Ø§Ù„Ø´
       function finishChallengeSequence() {
           closeFeedback();
           if (stickerNotificationQueue.length > 0) {
               showNextSticker();
           } else {
               showHome();
           }
       }

        // --- Ø§ÙÚ©Øª Ú©Ø§ØºØ° Ø±Ù†Ú¯ÛŒ ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function triggerConfetti() {
            for (let i = 0; i < 60; i++) {
                particles.push({
                    x: window.innerWidth / 2, y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 1) * 20,
                    color: ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43'][Math.floor(Math.random()*4)],
                    size: Math.random() * 8 + 4, life: 100, gravity: 0.5
                });
            }
            animateConfetti();
        }
        function animateConfetti() {
            if (particles.length === 0) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life--;
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.rect(p.x, p.y, p.size, p.size); ctx.fill();
            }
            particles = particles.filter(p => p.life > 0);
            requestAnimationFrame(animateConfetti);
        }

        // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
        });
    </script>
</body>
</html>